# v1.2.0 Feature Pack Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 9 user-requested features — skip sessions with comments, session history badges, step navigation in session, SVG icons in session, deficit formula explanation, 3 health calendars (pain/supplements/sleep), supplement ideal timing windows.

**Architecture:** All persistence in Dexie IndexedDB (`src/lib/db.ts`). UI follows inline-styles + CSS variables (NO Tailwind classes). Reusable `MonthCalendar` component shared across all 3 health calendar sections. Data layer changes (DB + supplements) must land first; UI tasks run in parallel after.

**Tech Stack:** Next.js 15 App Router, React 19, TypeScript, Dexie.js + `useLiveQuery`, Phosphor Icons (`@phosphor-icons/react`), CSS variables (`var(--color-*)`), inline styles only.

---

## Execution Order

```
Task 1 (DB + Data) → MUST LAND FIRST
  ↓ parallel ↓
Tasks 2, 3, 4, 5, 6 (independent)
  ↓
Tasks 7, 8, 9 (use MonthCalendar from Task 6)
  ↓
Build verify + commit
```

---

## Task 1: DB Schema + Supplement Timing Windows

**Files:**
- Modify: `src/lib/db.ts`
- Modify: `src/data/supplements.ts`

### What to add to `db.ts`

After the existing `DailyLog` interface, add:

```typescript
interface SkippedSession {
  id?: number
  sessionSlot: number        // 1–5 matching DailySession.id
  date: string               // YYYY-MM-DD
  reason: string             // user's comment
  skippedAt: string          // ISO 8601
}
```

In `RecoveryDatabase extends Dexie`:
- Add `skippedSessions!: Table<SkippedSession>` alongside other tables
- In `this.version(N).stores(...)` (increment version number by 1), add:
  `skippedSessions: '++id, date, sessionSlot'`

**IMPORTANT:** Check the current version number in `db.ts` and use `currentVersion + 1`. Do NOT break existing stores.

### What to add to `supplements.ts`

Add to `Supplement` interface:
```typescript
idealTimeFrom?: string   // e.g. "06:00"
idealTimeTo?: string     // e.g. "07:30"
idealNote?: string       // e.g. "За 30 мин до завтрака"
```

Add `idealTimeFrom`, `idealTimeTo`, `idealNote` to the existing supplement entries based on their `slot`:
- `fasting`: `idealTimeFrom: '06:00'`, `idealTimeTo: '07:00'`, `idealNote: 'Натощак, за 30–60 мин до еды'`
- `breakfast`: `idealTimeFrom: '07:30'`, `idealTimeTo: '08:30'`, `idealNote: 'Во время или сразу после завтрака'`
- `lunch`: `idealTimeFrom: '12:00'`, `idealTimeTo: '13:30'`, `idealNote: 'Во время обеда'`
- `dinner`: `idealTimeFrom: '18:00'`, `idealTimeTo: '20:00'`, `idealNote: 'Во время ужина'`
- `bedtime`: `idealTimeFrom: '21:00'`, `idealTimeTo: '22:30'`, `idealNote: 'За 30 мин до сна'`

### Step 1: Apply changes

Edit `db.ts` — add `SkippedSession` interface, add table declaration, increment version.
Edit `supplements.ts` — add three optional fields to interface, populate for all entries.

### Step 2: Verify build

```bash
cd /Users/clawdbot/projects/elbow-recovery && npm run build 2>&1 | tail -5
```
Expected: clean build, no TypeScript errors.

### Step 3: Commit

```bash
git add src/lib/db.ts src/data/supplements.ts
git commit -m "feat: add skippedSessions table + supplement timing windows"
```

---

## Task 2: Skip Session Button + History Badges in SessionList

**Files:**
- Modify: `src/components/dashboard/session-list.tsx`

### What to build

In `SessionList`, each session card currently links to `/session/:id`. Add:
1. A "Пропустить" button (small, secondary, right side of card) — opens inline dialog
2. Skip dialog: text area for reason + confirm button
3. After skip: card shows "Пропущено" badge instead of play button
4. Query `skippedSessions` via `useLiveQuery` to check if session was skipped today

### Implementation

```typescript
'use client'

import { useState } from 'react'
import Link from 'next/link'
import { useLiveQuery } from 'dexie-react-hooks'
import { db } from '@/lib/db'
import { useTodayData } from '@/hooks/use-today-data'
import { dailySessions } from '@/data/schedule'
import { CheckCircle, Circle, Play, XCircle, SkipForward } from '@phosphor-icons/react'

export function SessionList() {
  const { sessionsToday } = useTodayData()
  const today = new Date().toISOString().split('T')[0]

  // Track skip dialog state: null | sessionSlot number
  const [skipDialog, setSkipDialog] = useState<number | null>(null)
  const [skipReason, setSkipReason] = useState('')
  const [saving, setSaving] = useState(false)

  const completedSlots = new Set(sessionsToday.map(s => s.sessionSlot))

  const skippedSessions = useLiveQuery(
    () => db.skippedSessions.where('date').equals(today).toArray(),
    [today]
  ) ?? []
  const skippedSlots = new Set(skippedSessions.map(s => s.sessionSlot))

  const now = new Date()
  const currentHHMM = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`

  async function handleSkip(sessionSlot: number) {
    setSaving(true)
    await db.skippedSessions.add({
      sessionSlot,
      date: today,
      reason: skipReason.trim() || 'Без причины',
      skippedAt: new Date().toISOString(),
    })
    setSkipDialog(null)
    setSkipReason('')
    setSaving(false)
  }

  return (
    <div className="mt-6">
      <h2 className="text-lg font-semibold mb-3" style={{ color: 'var(--color-text)' }}>
        Сессии сегодня
      </h2>
      <div className="flex flex-col gap-2">
        {dailySessions.map((session) => {
          const isDone = completedSlots.has(session.id)
          const isSkipped = skippedSlots.has(session.id)
          const isPast = session.time < currentHHMM
          const isNext = !isDone && !isSkipped && !isPast

          return (
            <div key={session.id}>
              <div
                className="flex items-center gap-3 p-4 rounded-xl"
                style={{
                  backgroundColor: isDone
                    ? 'var(--color-primary-light)'
                    : isSkipped
                    ? 'color-mix(in srgb, var(--color-error) 8%, transparent)'
                    : 'var(--color-surface)',
                  border: isNext
                    ? '2px solid var(--color-primary)'
                    : isSkipped
                    ? '1px solid color-mix(in srgb, var(--color-error) 30%, transparent)'
                    : '1px solid var(--color-border)',
                }}
              >
                {/* Status icon */}
                {isDone ? (
                  <CheckCircle size={24} weight="fill" style={{ color: 'var(--color-primary)' }} />
                ) : isSkipped ? (
                  <XCircle size={24} weight="fill" style={{ color: 'var(--color-error)' }} />
                ) : (
                  <Circle size={24} style={{ color: 'var(--color-text-muted)' }} />
                )}

                {/* Session info — tappable area → session */}
                <Link href={`/session/${session.id}`} className="flex-1 min-w-0">
                  <p className="font-medium text-sm" style={{
                    color: isDone ? 'var(--color-primary)'
                         : isSkipped ? 'var(--color-error)'
                         : 'var(--color-text)'
                  }}>
                    {session.name}
                    {isSkipped && <span style={{ fontWeight: 400, fontSize: 11, marginLeft: 6 }}>
                      · {skippedSessions.find(s => s.sessionSlot === session.id)?.reason}
                    </span>}
                  </p>
                  <p className="text-xs" style={{ color: 'var(--color-text-muted)' }}>
                    {session.time} · {session.durationMin} мин · {session.steps.length} шагов
                  </p>
                </Link>

                {/* Right side: play or skip button */}
                {!isDone && !isSkipped && (
                  <button
                    onClick={(e) => { e.preventDefault(); setSkipDialog(session.id); setSkipReason('') }}
                    style={{
                      fontSize: 11,
                      color: 'var(--color-text-muted)',
                      background: 'transparent',
                      border: '1px solid var(--color-border)',
                      borderRadius: 8,
                      padding: '4px 8px',
                      cursor: 'pointer',
                    }}
                  >
                    Пропустить
                  </button>
                )}
                {isNext && !isDone && !isSkipped && (
                  <Link href={`/session/${session.id}`}>
                    <Play size={20} weight="fill" style={{ color: 'var(--color-primary)' }} />
                  </Link>
                )}
              </div>

              {/* Skip dialog (inline below card) */}
              {skipDialog === session.id && (
                <div style={{
                  background: 'var(--color-surface)',
                  border: '1px solid var(--color-border)',
                  borderRadius: 12,
                  padding: 16,
                  marginTop: 4,
                }}>
                  <p style={{ fontSize: 13, color: 'var(--color-text)', marginBottom: 8, fontWeight: 500 }}>
                    Причина пропуска (необязательно)
                  </p>
                  <textarea
                    value={skipReason}
                    onChange={e => setSkipReason(e.target.value)}
                    placeholder="Боль в локте, усталость, нет времени..."
                    rows={2}
                    style={{
                      width: '100%',
                      borderRadius: 8,
                      border: '1px solid var(--color-border)',
                      padding: '8px 10px',
                      fontSize: 13,
                      color: 'var(--color-text)',
                      background: 'var(--color-bg)',
                      resize: 'none',
                      boxSizing: 'border-box',
                    }}
                  />
                  <div style={{ display: 'flex', gap: 8, marginTop: 10 }}>
                    <button
                      onClick={() => handleSkip(session.id)}
                      disabled={saving}
                      style={{
                        flex: 1,
                        background: 'var(--color-error)',
                        color: 'white',
                        border: 'none',
                        borderRadius: 8,
                        padding: '10px',
                        fontSize: 13,
                        fontWeight: 600,
                        cursor: 'pointer',
                      }}
                    >
                      {saving ? 'Сохраняю...' : 'Пропустить сессию'}
                    </button>
                    <button
                      onClick={() => setSkipDialog(null)}
                      style={{
                        background: 'var(--color-surface)',
                        color: 'var(--color-text-muted)',
                        border: '1px solid var(--color-border)',
                        borderRadius: 8,
                        padding: '10px 16px',
                        fontSize: 13,
                        cursor: 'pointer',
                      }}
                    >
                      Отмена
                    </button>
                  </div>
                </div>
              )}
            </div>
          )
        })}
      </div>
    </div>
  )
}
```

### Step 1: Replace `session-list.tsx` with the above

### Step 2: Verify build

```bash
cd /Users/clawdbot/projects/elbow-recovery && npm run build 2>&1 | tail -5
```

### Step 3: Commit

```bash
git add src/components/dashboard/session-list.tsx
git commit -m "feat: skip session with reason + history badges in session list"
```

---

## Task 3: Step Navigation (Prev Button) in SessionRunner

**Files:**
- Modify: `src/components/session/session-runner.tsx`

### What to build

Currently: only "Далее/Завершить" (forward). Add:
1. "← Назад" button (left of "Далее") that decrements `currentStep`
2. Step pills at the top — row of dots showing position (current = filled, done = checkmark, upcoming = empty)
3. "Назад" disabled on step 0

### Step pill layout (add at top of session content area)

```typescript
{/* Step navigation pills */}
<div style={{ display: 'flex', gap: 6, justifyContent: 'center', marginBottom: 20 }}>
  {session.steps.map((_, idx) => (
    <div
      key={idx}
      style={{
        width: idx === currentStep ? 20 : 8,
        height: 8,
        borderRadius: 4,
        background: idx < currentStep
          ? 'var(--color-primary)'
          : idx === currentStep
          ? 'var(--color-primary)'
          : 'var(--color-border)',
        opacity: idx < currentStep ? 0.5 : 1,
        transition: 'all 0.25s ease',
      }}
    />
  ))}
</div>
```

### Navigation buttons

In the button row at the bottom (where "Далее/Завершить" lives), add "← Назад" on the left:

```typescript
<div style={{ display: 'flex', gap: 12, marginTop: 16 }}>
  {currentStep > 0 && (
    <button
      onClick={() => {
        setCurrentStep(prev => prev - 1)
        // Reset timer for previous step
      }}
      style={{
        flex: '0 0 auto',
        background: 'var(--color-surface)',
        color: 'var(--color-text-muted)',
        border: '1px solid var(--color-border)',
        borderRadius: 14,
        padding: '14px 20px',
        fontSize: 15,
        cursor: 'pointer',
      }}
    >
      ← Назад
    </button>
  )}
  {/* existing Далее/Завершить button — add flex: 1 */}
</div>
```

**Important:** When going back, call `clearTimerState()` equivalent (reset timer). The existing timer auto-resets when `step` changes via `useTimer` dependencies.

### Step 1: Read `session-runner.tsx` fully

Read the file to understand exact state shape, button location, and timer integration before editing.

### Step 2: Add step pills above session content, add "Назад" button

Edit `session-runner.tsx` with minimal targeted changes.

### Step 3: Verify build

```bash
cd /Users/clawdbot/projects/elbow-recovery && npm run build 2>&1 | tail -5
```

### Step 4: Commit

```bash
git add src/components/session/session-runner.tsx
git commit -m "feat: step navigation pills + prev button in session runner"
```

---

## Task 4: SVG Exercise Icons in Session Steps

**Files:**
- Modify: `src/components/session/session-runner.tsx`

### What to build

When a session step has `exerciseId`, render `<ExerciseSVG>` inside the step card — same animated SVGs used in the exercise catalog.

### Implementation

Add import at top of `session-runner.tsx`:
```typescript
import { ExerciseSVG } from '@/components/exercises/exercise-svg'
```

In the step render block (where step content is shown), add below the step title/description:

```typescript
{step.exerciseId && (
  <div style={{
    display: 'flex',
    justifyContent: 'center',
    margin: '16px 0',
    padding: 16,
    background: 'var(--color-surface)',
    borderRadius: 16,
    border: '1px solid var(--color-border)',
  }}>
    <ExerciseSVG exerciseId={step.exerciseId} size={140} />
  </div>
)}
```

Place it between the step name and the phases/notes section.

### Step 1: Read `session-runner.tsx` to find the exact step render location

Look for where `step.label` or `step.exerciseId` is currently rendered.

### Step 2: Add SVG import and render block

### Step 3: Verify build

```bash
cd /Users/clawdbot/projects/elbow-recovery && npm run build 2>&1 | tail -5
```

### Step 4: Commit

```bash
git add src/components/session/session-runner.tsx
git commit -m "feat: exercise SVG icons shown during session steps"
```

---

## Task 5: Deficit Formula Explanation on Progress Page

**Files:**
- Modify: `src/app/(app)/progress/page.tsx`

### What to build

Add an info card below the ROM badge explaining how deficit is calculated:

```
┌─────────────────────────────────────────────────┐
│ Как считается дефицит?                          │
│                                                 │
│ Дефицит разгибания                              │
│ 0° (норма) − ваше разгибание = X°               │
│ Пример: 0° − (−15°) = 15° дефицит              │
│                                                 │
│ Дефицит сгибания                                │
│ 145° (норма) − ваше сгибание = Y°               │
│ Пример: 145° − 110° = 35° дефицит              │
│                                                 │
│ Дуга движения = |разгибание| + сгибание         │
└─────────────────────────────────────────────────┘
```

### Component (inline in progress/page.tsx)

```typescript
function DeficitInfo() {
  const [open, setOpen] = useState(false)

  return (
    <div style={{ marginTop: 12 }}>
      <button
        onClick={() => setOpen(o => !o)}
        style={{
          background: 'transparent',
          border: 'none',
          color: 'var(--color-text-muted)',
          fontSize: 12,
          cursor: 'pointer',
          padding: 0,
          display: 'flex',
          alignItems: 'center',
          gap: 4,
        }}
      >
        <Info size={14} /> Как считается дефицит {open ? '▲' : '▼'}
      </button>

      {open && (
        <div style={{
          marginTop: 10,
          padding: 16,
          background: 'var(--color-surface)',
          borderRadius: 12,
          border: '1px solid var(--color-border)',
          fontSize: 13,
          lineHeight: 1.6,
          color: 'var(--color-text)',
        }}>
          <p style={{ fontWeight: 600, marginBottom: 8 }}>Дефицит разгибания</p>
          <p style={{ color: 'var(--color-text-muted)', marginBottom: 4 }}>
            <strong>0°</strong> (полное разгибание) − ваше разгибание = дефицит
          </p>
          <p style={{
            background: 'var(--color-bg)',
            borderRadius: 8,
            padding: '6px 10px',
            fontFamily: 'monospace',
            marginBottom: 12,
          }}>
            0° − (−15°) = <strong>15° дефицит</strong>
          </p>

          <p style={{ fontWeight: 600, marginBottom: 8 }}>Дефицит сгибания</p>
          <p style={{ color: 'var(--color-text-muted)', marginBottom: 4 }}>
            <strong>145°</strong> (норма) − ваше сгибание = дефицит
          </p>
          <p style={{
            background: 'var(--color-bg)',
            borderRadius: 8,
            padding: '6px 10px',
            fontFamily: 'monospace',
            marginBottom: 12,
          }}>
            145° − 110° = <strong>35° дефицит</strong>
          </p>

          <p style={{ fontWeight: 600, marginBottom: 4 }}>Дуга движения (ROM Arc)</p>
          <p style={{
            background: 'var(--color-bg)',
            borderRadius: 8,
            padding: '6px 10px',
            fontFamily: 'monospace',
          }}>
            |дефицит разгибания| + сгибание = arc
          </p>
        </div>
      )}
    </div>
  )
}
```

Add `import { Info } from '@phosphor-icons/react'` and `import { useState } from 'react'`.
Render `<DeficitInfo />` after the ROM badge section.

### Step 1: Read `progress/page.tsx` to find exact location for insert

### Step 2: Add `DeficitInfo` component and render it

### Step 3: Verify build

```bash
cd /Users/clawdbot/projects/elbow-recovery && npm run build 2>&1 | tail -5
```

### Step 4: Commit

```bash
git add src/app/(app)/progress/page.tsx
git commit -m "feat: deficit formula explanation on progress page"
```

---

## Task 6: Reusable MonthCalendar Component

**Files:**
- Create: `src/components/health/month-calendar.tsx`

### What to build

A generic calendar component used by pain, supplements, and sleep pages.

```typescript
'use client'

import { useState } from 'react'
import { CaretLeft, CaretRight } from '@phosphor-icons/react'

export interface CalendarDay {
  date: string          // YYYY-MM-DD
  hasData: boolean
  quality?: 'good' | 'warning' | 'bad' | 'neutral'  // for coloring
  label?: string        // short label (e.g. pain level "7")
}

interface MonthCalendarProps {
  days: CalendarDay[]
  onSelectDate: (date: string) => void
  selectedDate: string | null
  title?: string
}

export function MonthCalendar({ days, onSelectDate, selectedDate, title }: MonthCalendarProps) {
  const today = new Date()
  const [viewYear, setViewYear] = useState(today.getFullYear())
  const [viewMonth, setViewMonth] = useState(today.getMonth()) // 0-indexed

  // Build lookup map
  const dayMap = new Map(days.map(d => [d.date, d]))

  // Get all days in the viewed month
  const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate()
  const firstDayOfWeek = new Date(viewYear, viewMonth, 1).getDay() // 0=Sun

  // Adjust: start from Monday (Russian standard)
  const startOffset = (firstDayOfWeek + 6) % 7

  const monthName = new Date(viewYear, viewMonth, 1).toLocaleDateString('ru-RU', {
    month: 'long',
    year: 'numeric',
  })

  function prevMonth() {
    if (viewMonth === 0) { setViewYear(y => y - 1); setViewMonth(11) }
    else setViewMonth(m => m - 1)
  }
  function nextMonth() {
    if (viewMonth === 11) { setViewYear(y => y + 1); setViewMonth(0) }
    else setViewMonth(m => m + 1)
  }

  const qualityColor = (q?: CalendarDay['quality']) => {
    switch (q) {
      case 'good': return 'var(--color-primary)'
      case 'warning': return 'var(--color-warning, #f59e0b)'
      case 'bad': return 'var(--color-error)'
      default: return 'var(--color-border)'
    }
  }

  return (
    <div style={{ marginTop: 24 }}>
      {title && (
        <p style={{ fontSize: 13, fontWeight: 600, color: 'var(--color-text-muted)', marginBottom: 12, textTransform: 'uppercase', letterSpacing: '0.05em' }}>
          {title}
        </p>
      )}

      {/* Month header */}
      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 12 }}>
        <button onClick={prevMonth} style={{ background: 'transparent', border: 'none', cursor: 'pointer', color: 'var(--color-text-muted)', padding: 4 }}>
          <CaretLeft size={18} />
        </button>
        <span style={{ fontSize: 14, fontWeight: 600, color: 'var(--color-text)', textTransform: 'capitalize' }}>
          {monthName}
        </span>
        <button onClick={nextMonth} style={{ background: 'transparent', border: 'none', cursor: 'pointer', color: 'var(--color-text-muted)', padding: 4 }}>
          <CaretRight size={18} />
        </button>
      </div>

      {/* Weekday headers (Mon–Sun) */}
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: 2, marginBottom: 4 }}>
        {['Пн','Вт','Ср','Чт','Пт','Сб','Вс'].map(d => (
          <div key={d} style={{ textAlign: 'center', fontSize: 10, color: 'var(--color-text-muted)', padding: '2px 0' }}>
            {d}
          </div>
        ))}
      </div>

      {/* Day grid */}
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: 3 }}>
        {/* Empty offset cells */}
        {Array.from({ length: startOffset }).map((_, i) => (
          <div key={`empty-${i}`} />
        ))}

        {/* Day cells */}
        {Array.from({ length: daysInMonth }).map((_, i) => {
          const dayNum = i + 1
          const dateStr = `${viewYear}-${String(viewMonth + 1).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}`
          const dayData = dayMap.get(dateStr)
          const isToday = dateStr === today.toISOString().split('T')[0]
          const isSelected = dateStr === selectedDate
          const isFuture = dateStr > today.toISOString().split('T')[0]

          return (
            <button
              key={dateStr}
              onClick={() => !isFuture && onSelectDate(dateStr)}
              disabled={isFuture}
              style={{
                position: 'relative',
                aspectRatio: '1',
                borderRadius: 8,
                border: isSelected
                  ? '2px solid var(--color-primary)'
                  : isToday
                  ? '1px solid var(--color-primary)'
                  : '1px solid transparent',
                background: isSelected
                  ? 'var(--color-primary-light)'
                  : dayData?.hasData
                  ? `color-mix(in srgb, ${qualityColor(dayData.quality)} 18%, transparent)`
                  : 'transparent',
                cursor: isFuture ? 'default' : 'pointer',
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                gap: 1,
                padding: 2,
                opacity: isFuture ? 0.3 : 1,
              }}
            >
              <span style={{
                fontSize: 11,
                fontWeight: isToday ? 700 : 400,
                color: isSelected ? 'var(--color-primary)' : 'var(--color-text)',
              }}>
                {dayNum}
              </span>
              {dayData?.hasData && dayData.label && (
                <span style={{ fontSize: 8, color: qualityColor(dayData.quality), fontWeight: 600 }}>
                  {dayData.label}
                </span>
              )}
              {dayData?.hasData && !dayData.label && (
                <div style={{
                  width: 4, height: 4, borderRadius: '50%',
                  background: qualityColor(dayData.quality),
                }} />
              )}
            </button>
          )
        })}
      </div>
    </div>
  )
}
```

### Step 1: Create `src/components/health/month-calendar.tsx` with the above code

### Step 2: Verify build

```bash
cd /Users/clawdbot/projects/elbow-recovery && npm run build 2>&1 | tail -5
```

### Step 3: Commit

```bash
git add src/components/health/month-calendar.tsx
git commit -m "feat: reusable MonthCalendar component for health pages"
```

---

## Task 7: Pain Diary Calendar

**Files:**
- Modify: `src/app/(app)/health/pain/page.tsx`

### What to build

Add a `MonthCalendar` section above the today's entries list. When user taps a date:
- If it's today → show today's entries (already rendered below)
- If it's a past date → show that day's entries in an expandable panel

### Data query

```typescript
// Get all pain entries for the viewed month range
const allPainEntries = useLiveQuery(
  () => db.painEntries.orderBy('date').toArray(),
  []
) ?? []

// Build CalendarDay[] for MonthCalendar
const calendarDays: CalendarDay[] = useMemo(() => {
  const byDate = new Map<string, PainEntry[]>()
  for (const entry of allPainEntries) {
    if (!byDate.has(entry.date)) byDate.set(entry.date, [])
    byDate.get(entry.date)!.push(entry)
  }
  return Array.from(byDate.entries()).map(([date, entries]) => {
    const maxLevel = Math.max(...entries.map(e => e.level))
    return {
      date,
      hasData: true,
      quality: maxLevel <= 3 ? 'good' : maxLevel <= 6 ? 'warning' : 'bad',
      label: String(maxLevel),
    }
  })
}, [allPainEntries])
```

### Selected date panel

```typescript
const [selectedDate, setSelectedDate] = useState<string | null>(null)

const selectedEntries = useLiveQuery(
  () => selectedDate
    ? db.painEntries.where('date').equals(selectedDate).sortBy('time')
    : Promise.resolve([]),
  [selectedDate]
) ?? []
```

Show `selectedEntries` in the same expandable list format as today's entries, below the calendar.

### Step 1: Read `health/pain/page.tsx` fully

### Step 2: Add imports, state, queries, CalendarDay computation, and render calendar + selected day panel

Place the calendar section between the header and the PainForm. Place selected-day results between the calendar and the form (or as a separate section labeled with the date).

### Step 3: Verify build

### Step 4: Commit

```bash
git add src/app/(app)/health/pain/page.tsx
git commit -m "feat: pain diary calendar with date selection"
```

---

## Task 8: Supplements Calendar + Ideal Timing

**Files:**
- Modify: `src/app/(app)/health/supplements/page.tsx`
- Modify: `src/components/health/supplement-checklist.tsx`

### Part A: Ideal timing in SupplementChecklist

Read `supplement-checklist.tsx`. In each supplement card, show the ideal time window:
```typescript
{supplement.idealNote && (
  <span style={{ fontSize: 10, color: 'var(--color-text-muted)', display: 'block', marginTop: 2 }}>
    ⏱ {supplement.idealNote} ({supplement.idealTimeFrom}–{supplement.idealTimeTo})
  </span>
)}
```

### Part B: Supplements Calendar

In `supplements/page.tsx`, add a `MonthCalendar` section showing supplement adherence by day.

```typescript
const allSupplementLogs = useLiveQuery(
  () => db.supplementLogs.orderBy('date').toArray(),
  []
) ?? []

const calendarDays: CalendarDay[] = useMemo(() => {
  const byDate = new Map<string, SupplementLog[]>()
  for (const log of allSupplementLogs) {
    if (!byDate.has(log.date)) byDate.set(log.date, [])
    byDate.get(log.date)!.push(log)
  }
  return Array.from(byDate.entries()).map(([date, logs]) => {
    const taken = logs.filter(l => l.taken).length
    const total = logs.length
    const pct = total > 0 ? taken / total : 0
    return {
      date,
      hasData: total > 0,
      quality: pct >= 0.9 ? 'good' : pct >= 0.6 ? 'warning' : 'bad',
      label: `${taken}/${total}`,
    }
  })
}, [allSupplementLogs])
```

When user selects a date → show that day's supplement log (which supplements were taken, which skipped).

### Step 1: Read `supplement-checklist.tsx` + `supplements/page.tsx`

### Step 2: Add timing display to SupplementChecklist

### Step 3: Add calendar + day detail to supplements page

### Step 4: Verify build

### Step 5: Commit

```bash
git add src/app/(app)/health/supplements/page.tsx src/components/health/supplement-checklist.tsx
git commit -m "feat: supplements calendar + ideal timing display"
```

---

## Task 9: Sleep Protocol Calendar

**Files:**
- Modify: `src/app/(app)/health/sleep/page.tsx`

### What to build

Add `MonthCalendar` below the HormoneTimeline and above the SleepForm showing sleep quality by day.

```typescript
const allSleepLogs = useLiveQuery(
  () => db.sleepLogs.orderBy('date').toArray(),
  []
) ?? []

const calendarDays: CalendarDay[] = useMemo(() => {
  return allSleepLogs.map(log => ({
    date: log.date,
    hasData: true,
    quality: log.totalHours >= 7.5 ? 'good' : log.totalHours >= 6 ? 'warning' : 'bad',
    label: `${log.totalHours}ч`,
  }))
}, [allSleepLogs])
```

When date selected → show that day's sleep log inline (hours, quality stars, bedTime → wakeTime, notes).

### Step 1: Read `health/sleep/page.tsx` fully

### Step 2: Add imports, state, queries, calendar render, selected day detail

### Step 3: Verify build

### Step 4: Commit

```bash
git add src/app/(app)/health/sleep/page.tsx
git commit -m "feat: sleep protocol calendar with history"
```

---

## Final: Build Verify + Version Bump + Push

### Step 1: Full build

```bash
cd /Users/clawdbot/projects/elbow-recovery && npm run build 2>&1
```
Expected: 0 TypeScript errors, all routes static/dynamic as before.

### Step 2: Update version in `package.json`

Change `"version": "1.1.0"` → `"version": "1.2.0"`.

### Step 3: Final commit + push

```bash
git add package.json
git commit -m "chore: bump version to 1.2.0"
git push
```

---

## Summary Table

| Task | Feature | Files | Parallel? |
|------|---------|-------|-----------|
| 1 | DB schema + supplement timing | `db.ts`, `supplements.ts` | Must be first |
| 2 | Skip session + reason dialog | `session-list.tsx` | After Task 1 |
| 3 | Step navigation (prev + pills) | `session-runner.tsx` | After Task 1 |
| 4 | SVG icons in session steps | `session-runner.tsx` | After Task 3 |
| 5 | Deficit formula on progress | `progress/page.tsx` | Independent |
| 6 | MonthCalendar component | `health/month-calendar.tsx` | After Task 1 |
| 7 | Pain calendar | `health/pain/page.tsx` | After Task 6 |
| 8 | Supplements calendar + timing | `supplements/page.tsx`, `supplement-checklist.tsx` | After Task 6 |
| 9 | Sleep calendar | `health/sleep/page.tsx` | After Task 6 |
